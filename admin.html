<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾Œå°ç®¡ç†ç³»çµ±</title>
  <script>
    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ï¼Œæœªç™»å…¥å‰‡å°å›ç™»å…¥é é¢
    if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
      window.location.href = 'login.html';
    }
  </script>
  <style>
    body { font-family: sans-serif; max-width: 1000px; margin: auto; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { text-align: center; }
    td { text-align: left; }
    td.price { text-align: right; }
    input, select { padding: 5px; }
    button { padding: 8px 12px; margin: 5px; }
    .in-stock { color: green; font-weight: bold; }
    .out-stock { color: gray; font-weight: bold; }
    .hot-stock { color: red; font-weight: bold; }
    .upload-section { margin-top: 20px; background: #f1f1f1; padding: 10px; border-radius: 6px; }
  </style>
</head>
<body>

<h1>ğŸ“¦ å¾Œå°è—¥å“ç®¡ç† (è³‡æ–™åŒæ­¥å‰å°)</h1>

<div>
  <label>åˆ†é¡ï¼š</label>
  <select id="categorySelect">
    <option value="products">ä¸€èˆ¬è—¥å“</option>
    <option value="specialProducts">å£¯é™½/é¿å­•/ç„¡å¥ä¿è—¥ç‰©</option>
    <option value="coldProducts">å†·å“</option>
  </select>
  <button onclick="loadCategory()">è¼‰å…¥</button>
</div>

<table>
  <thead>
    <tr>
      <th>å¥ä¿ç¢¼</th>
      <th>è—¥å“åç¨±</th>
      <th>è¦æ ¼</th>
      <th>å„ªæƒ åƒ¹</th>
      <th>åº«å­˜ç‹€æ…‹</th>
      <th>åˆªé™¤</th>
    </tr>
  </thead>
  <tbody id="adminTableBody"></tbody>
</table>

<div>
  <h3>æ–°å¢è—¥å“</h3>
  <input id="nhicode" placeholder="å¥ä¿ç¢¼">
  <input id="medname" placeholder="è—¥å“åç¨±">
  <input id="spec" placeholder="è¦æ ¼">
  <input id="price" type="number" placeholder="å„ªæƒ åƒ¹">
  <select id="stock">
    <option value="ä¾›è²¨ä¸­">ä¾›è²¨ä¸­</option>
    <option value="ç¼ºè²¨ä¸­">ç¼ºè²¨ä¸­</option>
    <option value="ç†±é–€ğŸ”¥">ç†±é–€ğŸ”¥</option>
  </select>
  <button onclick="saveItem()">å„²å­˜</button>
</div>

<div class="upload-section">
  <h3>æ‰¹é‡ä¸Šå‚³ CSV</h3>
  <input type="file" id="fileInput" accept=".csv">
  <button onclick="importCSV()">åŒ¯å…¥</button>
  <p>ğŸ“¥ <a href="sample_utf8_bom.csv" download>ä¸‹è¼‰ç¯„ä¾‹æª”æ¡ˆ</a></p>
</div>

<script>
  let data = JSON.parse(localStorage.getItem('drugData')) || {
    products: [],
    specialProducts: [],
    coldProducts: []
  };

  let currentCategory = 'products';

  function renderAdminTable(list) {
    const tableBody = document.getElementById('adminTableBody');
    tableBody.innerHTML = '';
    list.forEach((p, i) => {
      let stockClass = 'in-stock';
      if (p.stock.includes('ç¼ºè²¨')) stockClass = 'out-stock';
      else if (p.stock.includes('ç†±é–€')) stockClass = 'hot-stock';
      const row = document.createElement('tr');
      row.innerHTML = `
        <td contenteditable="true" oninput="updateField(${i}, 'nhicode', this.innerText)">${p.nhicode}</td>
        <td contenteditable="true" oninput="updateField(${i}, 'medname', this.innerText)">${p.medname}</td>
        <td contenteditable="true" oninput="updateField(${i}, 'spec', this.innerText)">${p.spec}</td>
        <td contenteditable="true" class="price" oninput="updateField(${i}, 'price', this.innerText)">${p.price}</td>
        <td contenteditable="true" oninput="updateField(${i}, 'stock', this.innerText)" class="${stockClass}">${p.stock}</td>
        <td><button onclick="deleteItem(${i})">åˆªé™¤</button></td>
      `;
      tableBody.appendChild(row);
    });
    saveData();
  }

  function loadCategory() {
    currentCategory = document.getElementById('categorySelect').value;
    renderAdminTable(data[currentCategory]);
  }

  function saveItem() {
    const item = {
      nhicode: document.getElementById('nhicode').value,
      medname: document.getElementById('medname').value,
      spec: document.getElementById('spec').value,
      price: parseFloat(document.getElementById('price').value),
      stock: document.getElementById('stock').value
    };
    data[currentCategory].push(item);
    renderAdminTable(data[currentCategory]);
    clearForm();
  }

  function updateField(index, field, value) {
    if (field === 'price') {
      value = parseFloat(value) || 0;
    }
    data[currentCategory][index][field] = value;
    saveData();
  }

  function deleteItem(index) {
    data[currentCategory].splice(index, 1);
    renderAdminTable(data[currentCategory]);
  }

  function clearForm() {
    document.getElementById('nhicode').value = '';
    document.getElementById('medname').value = '';
    document.getElementById('spec').value = '';
    document.getElementById('price').value = '';
    document.getElementById('stock').value = 'ä¾›è²¨ä¸­';
  }

  function saveData() {
    localStorage.setItem('drugData', JSON.stringify(data));
  }

  function importCSV() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return alert('è«‹é¸æ“‡ CSV æª”æ¡ˆ');

    const reader = new FileReader();
    reader.onload = function(e) {
      const lines = e.target.result.split('\n').slice(1); // å»é™¤æ¨™é¡Œ
      lines.forEach(line => {
        const cols = line.split(',');
        if (cols.length >= 5) {
          data[currentCategory].push({
            nhicode: cols[0],
            medname: cols[1],
            spec: cols[2],
            price: parseFloat(cols[3]),
            stock: cols[4]
          });
        }
      });
      saveData();
      renderAdminTable(data[currentCategory]);
      alert('æ‰¹é‡ä¸Šå‚³å®Œæˆï¼');
    };
    reader.readAsText(file, 'utf-8');
  }

  window.onload = loadCategory;
</script>

</body>
</html>
